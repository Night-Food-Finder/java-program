<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.nff.repository.dao.StatDAO">

	<!-- 전체 단골 등록 수 -->
	<select id="frequentCountAll" resultType="int">
		select count(*)
		from tb_frequent_store
	</select>

	<!-- store 단골 랭킹 리스트 -->
	<select id="statFrequentStore" parameterType="Search"
		resultType="Stat">
   	 select *
    from frequent_view f
    left outer join (
		select count(store_no) as fqCount, store_no as st
		from frequent_view
		 <where>
       <include refid="statAgeFilter"/>
       </where>
		group by st
    ) freCnt
    on f.store_no = st
    group by f.store_no
    order by fqCount desc;
	</select>
	
	<select id="statMaleFrequentStore" parameterType="Search"
		resultType="Stat">
     select *
    from frequent_view f
    left outer join (
     select count(user_no) fqCount, store_no as st
       from frequent_view
       where user_gender = 'M'
       <include refid="statAgeFilter"/>
       group by st
    ) male
      on f.store_no = st
    group by f.store_no
    order by fqCount desc;
	</select>

	<select id="statFemaleFrequentStore" parameterType="Search"
		resultType="Stat">
  select *
    from frequent_view f
    left outer join (
     select count(user_no) fqCount, store_no as st
       from frequent_view
       where user_gender = 'F'
       <include refid="statAgeFilter"/>
       group by st
    ) female
      on f.store_no = st
    group by f.store_no
    order by fqCount desc;
    	</select>



	<!-- 연령별 필터 -->
		<sql id="statAgeFilter">
		<if test="userAge != null and userAge != ''">
		and user_age like #{userAge}
		</if>
	</sql>
	<!-- 성별 필터 -->
		<sql id="statGenderFilter">
		<if test="type != null and type != ''">
			and user_gender like '%' || #{type} || '%'
		</if>
	</sql>
	
	
	<insert id="insertVisitor" parameterType="Stat">
		insert into tb_visitor
		(visit_ip, visit_date, date_time) values
		(#{visitIp}, curdate(), now())
	
	</insert>
	
	<select id="visitorList" resultType="Stat">
		select count(*) as totalVisit, 
		(select count(*) from tb_visitor where visit_date = curdate()) as todayVisit from tb_visitor;
	</select>
	
	<select id="countByDate" resultType="Stat">
		 select date_time, count(*) as byDate from tb_visitor 
		 where date_time between date_add(now(), INTERVAL -1 month ) and now()
		 group by visit_date order by date_time;

	</select>
	
</mapper>