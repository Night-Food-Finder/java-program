<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.nff.repository.dao.statDAO">

	<!-- 전체 단골 등록 수 -->
	<select id="frequentCountAll" resultType="int">
		select count(*)
		from tb_frequent_store
	</select>

	<!-- store 단골 랭킹 리스트 -->
	<select id="statFrequentStore" parameterType="Search"
		resultType="Stat">
		  select *
    from frequent_view f
    left outer join (
		select count(store_no) as allfq, store_no
		from frequent_view
		group by store_no
    ) freCnt
    on f.store_no = freCnt.store_no
    left outer join (
     select count(user_no) filterfq, store_no
       from frequent_view
       <where>
       <include refid="statGenderFilter"/>
       <include refid="statAgeFilter"/>
       </where>
       group by store_no
    ) gen
    on f.store_no = gen.store_no
    group by f.store_no
    order by filterfq desc

		<!-- 페이징 -->
		LIMIT #{startList}, #{listSize}

	</select>
	

	<!-- 연령별 필터 -->
		<sql id="statAgeFilter">
		<if test="ageCode != null and ageCode != ''">
		and user_age in
			<foreach item="age" index="index"
				collection="ageCode" open="(" separator="," close=")">
				#{age.value}
			</foreach>
		</if>
	</sql>
	<!-- 성별 필터 -->
		<sql id="statGenderFilter">
		<if test="type != null and type != ''">
			and user_gender like '%' || #{type} || '%'
		</if>
	</sql>
</mapper>